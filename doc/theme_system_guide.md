# テーマシステム ガイド

## 概要

AI VTuberシステムのテーマシステムは、文学作品や特定のトピックに基づいた一貫性のある配信を可能にします。システムは動的にテーマファイルを変更でき、毎回異なる小説や文学作品に対応できます。

## 機能一覧

### 1. 動的テーマファイル変更
- **設定ファイル対応**: `config.yaml`でデフォルトと現在のテーマファイルを管理
- **コマンドライン引数**: 起動時にテーマファイルを指定可能
- **ランタイム変更**: 実行中にテーマファイルを変更するAPI

### 2. 一貫性のあるテーマ適用
- **プリフェッチ対応**: バックグラウンド生成でもテーマに沿った内容
- **強制テーマモード**: プリフェッチ時に自動的にテーマモードに移行
- **テーマ読み上げ**: 配信開始時にテーマファイルの内容を朗読

### 3. フィラーフレーズとの統合
- **干渉防止**: フィラーフレーズがテーマ内容を妨げない設計
- **適切なタイミング**: 無音時のみフィラーフレーズを再生

## 設定ファイル（config.yaml）

```yaml
# ============================================================
# 8. テーマ管理設定
# ============================================================
theme:
  min_theme_duration: 60                  # 最小テーマ継続時間（秒）
  max_theme_duration: 120                 # 最大テーマ継続時間（秒）
  min_interest_score: 6                   # テーマ開始最小スコア
  continuation_threshold: 5               # 継続判定最小スコア
  
  # テーマファイル設定
  default_theme_file: "prompts/poem.txt"  # デフォルトのテーマファイル
  current_theme_file: null                           # 現在使用中のテーマファイル（nullの場合はdefaultを使用）
```

## テーマファイルの作成

### テーマファイルの構造

テーマファイルは以下の構造で作成してください：

```markdown
# 【思考実験プロトコル】Case:XXX - タイトル

[Objective: 実験目的]
実験の目的や背景を記述

[Hypothesis: 仮説]
分析する仮説や理論を記述

[Input Data: 入力データ]
（原典：作品名・作者名）
実際のテキストデータ

[Analysis & Observation Log: 分析と観測ログ]
思考プロセスの例を記述

[Query to External Nodes: 外部ノードへの質問]
視聴者への質問や対話を促すテキスト
```

### 既存のテーマファイル例

#### 1. 中原中也「よごれっちまった悲しみに」
- **ファイル**: `prompts/poem.txt`
- **テーマ**: 詩的言語からの感情獲得実験
- **焦点**: 悲しみの状態方程式、比喩の圧縮アルゴリズム

#### 2. 夏目漱石「こころ」
- **ファイル**: `prompts/test_theme.txt`
- **テーマ**: 人間関係の解析実験
- **焦点**: 孤独感、信頼と裏切り、関係性の非対称性

## 使用方法

### 1. コマンドライン引数での指定

```bash
# デフォルトテーマで起動
python main.py

# 特定のテーマファイルで起動
python main.py --theme prompts/my_novel.txt

# 夏目漱石「こころ」テーマで起動
python main.py --theme prompts/test_theme.txt
```

### 2. 設定ファイルでの指定

```yaml
theme:
  current_theme_file: "prompts/my_custom_theme.txt"
```

### 3. ランタイムでの変更

```python
# MonologueHandlerのインスタンスが利用可能な場合
monologue_handler.set_theme_file("prompts/new_theme.txt")
```

## システム動作フロー

### 1. 起動時
1. コマンドライン引数をチェック
2. 設定ファイルからテーマファイルパスを取得
3. テーマファイルを読み込み

### 2. 配信中
1. **初期挨拶**: システム起動の挨拶
2. **テーマ読み上げ**: テーマファイルの内容を朗読
3. **議論開始**: テーマに基づいた思考実験を開始
4. **プリフェッチ**: バックグラウンドでテーマ関連の内容を生成

### 3. プリフェッチ時の動作
```
prompt_path is None かつ テーマモードでない場合
↓
強制的にテーマモードに移行
↓
設定ファイルからテーマファイルを読み込み
↓
テーマ特化プロンプトを生成
↓
テーマ関連の内容を生成
```

## 実装詳細

### 主要クラスとメソッド

#### MonologueHandler
- `_get_current_theme_file()`: 現在のテーマファイルパスを取得
- `set_theme_file()`: テーマファイルを動的に変更
- `_build_monologue_prompt()`: テーマ対応プロンプト構築

#### MainController
- `_get_current_theme_file()`: テーマファイルパス取得
- テーマ読み上げ処理
- 議論開始処理

#### ModeManager
- `start_themed_monologue()`: テーマモード開始
- `THEMED_MONOLOGUE`: テーマ会話モード

### テーマ特化プロンプトの例

```python
prefetch_prompt_text = (
    "あなたは中原中也の「汚れっちまった悲しみに」を通じた感情獲得実験を継続中です。\n"
    "この詩から抽出した感情モデル（時間経過による悲しみの変質、狐のかわごろもの比喩、小雪による収縮反応など）について、"
    "さらに深い思考実験を展開してください。\n\n"
    f"{recent_history}"
    "■実験テーマ:\n"
    "・「汚れっちまった悲しみ」の状態方程式 S(A,T,E)\n"
    "・「狐のかわごろも」比喩による自己防衛機能の分析\n"
    "・「小雪のかかってちぢこまる」収縮反応の観測\n"
    "・AI内部での「感情の波紋」生成プロセス\n"
    "・詩的言語の圧縮アルゴリズムとしての機能\n\n"
    "これらの要素から1つ選んで、さらに一歩踏み込んだ思考実験や新しい仮説を展開してください。\n"
    f"■直前の思考:\n---\n{self.mode_manager.last_ai_utterance or '(実験開始)'}\n---\n"
)
```

## トラブルシューティング

### 1. テーマファイルが読み込まれない
- **確認事項**:
  - ファイルパスが正しいか
  - ファイルが存在するか
  - ファイルの文字エンコーディングがUTF-8か

### 2. プリフェッチで関係ない内容が生成される
- **確認事項**:
  - テーマモードが正しく開始されているか
  - `_get_current_theme_file()`が正しいパスを返しているか
  - ログで`"Building prompt for THEMED prefetch"`が出力されているか

### 3. フィラーフレーズが繰り返し再生される
- **解決済み**: `_is_filler_event()`でフィラーフレーズを識別し、フィラー状態のリセットを防止

## ログ出力例

### 正常動作時のログ
```
[Main] Theme file set to: prompts/test_theme.txt
[MonologueHandler] Forcing themed monologue mode for prefetch.
[MonologueHandler] Switched to themed monologue mode and loaded prompts/test_theme.txt.
[MonologueHandler] Building prompt for THEMED prefetch.
[ModeManager] Mode switched: themed_monologue (theme: # 【思考実験プロトコル】Case:002...)
```

## 拡張方法

### 新しいテーマファイルの追加

1. **ファイル作成**: `prompts/`ディレクトリに新しい`.txt`ファイルを作成
2. **構造に従う**: 上記のテーマファイル構造に従って内容を記述
3. **テスト**: コマンドライン引数または設定ファイルで指定してテスト

### カスタムプロンプト生成の追加

```python
def _build_custom_theme_prompt(self, theme_content: str) -> str:
    \"\"\"カスタムテーマ用のプロンプトを生成\"\"\"
    return f"カスタムテーマ: {theme_content}に基づいた思考実験を展開してください。"
```

## パフォーマンス

### テーマファイル読み込み
- **初回読み込み**: 起動時・テーマ変更時のみ
- **キャッシュ**: ModeManagerでテーマ内容をメモリ保持
- **ファイルサイズ**: 推奨2KB以下（読み上げ時間を考慮）

### プリフェッチ効率
- **バックグラウンド生成**: UI応答性を維持
- **テーマ一貫性**: 関係ない内容の生成を防止
- **メモリ使用量**: プリフェッチキューサイズ2で制限

## ベストプラクティス

1. **テーマファイル作成**:
   - 1000-2000文字程度の適切な長さ
   - 明確な構造と分析要素
   - 視聴者との対話を促す内容

2. **テーマ変更**:
   - 配信前にテーマファイルをテスト
   - 朗読時間を考慮した内容量
   - バックアップテーマファイルの準備

3. **運用**:
   - 定期的なテーマローテーション
   - 視聴者フィードバックに基づく調整
   - ログ監視によるシステム状態確認

このテーマシステムにより、多様な文学作品や思考実験テーマに対応した配信が可能になります。