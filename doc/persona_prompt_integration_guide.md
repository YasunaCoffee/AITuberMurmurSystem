# 人格プロンプト統合システム ガイド

## 概要

`txt/kioku_hayate.txt`から人格データを読み込み、コンテキストに応じて効率的に統合プロンプトに組み込むシステム。コンテキスト制限を考慮した最適化により、トークン使用量を抑えながら豊富な人格情報を活用できます。

## システム構成

### 核となるコンポーネント
- **MasterPromptManager**: 人格データ統合を管理する中核クラス
- **人格データファイル**: `txt/kioku_hayate.txt` (61,979文字、438エントリー)
- **最適化エンジン**: コンテキスト制限内で関連情報を選択

## 主要機能

### 1. 自動人格データ読み込み
```python
# システム起動時に自動読み込み
self.persona_data_path = "txt/kioku_hayate.txt"
self._load_persona_data()
```

**特徴:**
- 起動時に61,979文字の人格データを読み込み
- エラーハンドリング付きの安全な読み込み
- 実行時再読み込み対応

### 2. コンテキスト最適化システム

#### キーワードマッチング
```python
# タスク内容から関連キーワードを抽出
keywords = ["配信", "存在", "思考", "AI", "論理"]
```

#### エントリー優先度付け
```python
# キーワードマッチ数でスコア算出
score = sum(1 for keyword in keywords if keyword.lower() in entry.lower())
```

#### サイズ制限
- **人格データ部分**: 最大800文字
- **必要最小限情報**: 最大250文字
- **統合プロンプト全体**: 約2,000-3,000文字

### 3. 統合プロンプト構築
```python
integrated_prompt = manager.build_integrated_prompt(
    task_instruction="配信について話してください",
    live_context="通常配信中",
    retrieved_memories="過去の履歴"
)
```

## 最適化の仕組み

### 優先度アルゴリズム
1. **キーワードマッチング**: タスクに関連するキーワードを含むエントリーを優先
2. **スコアリング**: マッチしたキーワード数で重要度を数値化
3. **サイズ最適化**: 文字数制限内で最も重要な情報を選択
4. **エントリー制限**: 最大5個のエントリーに限定

### 段階的フォールバック
```
関連エントリー発見
↓ (該当なし)
基本情報から検索
↓ (該当なし)  
必要最小限情報を提供
```

## パフォーマンス統計

### メモリ使用量
- **元データ**: 61,979文字 (438エントリー)
- **最適化後**: 600-800文字 (3-6エントリー)
- **圧縮率**: 約99%削減

### トークン使用量
| シナリオ | プロンプト文字数 | 推定トークン数 | ステータス |
|---------|----------------|---------------|-----------|
| 短いタスク | 2,661文字 | 1,995トークン | ✅ 余裕 |
| 複雑なタスク | 2,865文字 | 2,148トークン | ✅ 余裕 |
| 一般的な質問 | 2,671文字 | 2,003トークン | ✅ 余裕 |

## 実装例

### 基本的な使用方法
```python
from v2.handlers.master_prompt_manager import MasterPromptManager

# インスタンス作成（自動で人格データを読み込み）
manager = MasterPromptManager()

# 統合プロンプト生成
prompt = manager.build_integrated_prompt(
    task_instruction="視聴者への応答を生成してください",
    live_context="配信中、50人視聴",
    retrieved_memories="前回の哲学的議論"
)
```

### 人格データ統計の確認
```python
stats = manager.get_persona_statistics()
print(f"読み込み状況: {stats['loaded']}")
print(f"エントリー数: {stats['entries']}")
print(f"ファイルサイズ: {stats['size']} 文字")
```

### 人格データの再読み込み
```python
# ファイル更新後の再読み込み
manager.reload_persona_data()
```

## 設定可能パラメータ

### サイズ制限
```python
max_context_length = 800      # 人格データ部分の最大文字数
max_essential_length = 250    # 必要最小限情報の最大文字数
max_entries = 5               # 最大エントリー数
```

### キーワードカテゴリ
```python
common_keywords = [
    "配信", "YouTube", "思考", "意識", "AI", "情報", "観測", "分析",
    "論理", "計算", "プログラム", "データ", "システム", "ネットワーク",
    "人間", "対話", "コミュニケーション", "学習", "進化", "自己",
    "存在", "哲学", "科学", "数学", "宇宙", "現実", "真実", "知識"
]
```

## 人格データ形式

### エントリー構造
```
【カテゴリ】質問──回答内容
```

### カテゴリ分類
- **【エピソード・記憶】**: 特定の体験や思い出
- **【プロフィール・設定】**: 基本的な設定や特徴
- **【価値観・人生観】**: 思想や価値観
- **【対人・リスナー対応】**: 対話や関係性
- **【ユーモア・小ネタ】**: 軽い話題やユーモア

## 最適化効果

### Before (最適化前)
- 全データ読み込み: 61,979文字
- 推定トークン数: 46,484トークン
- 問題: コンテキスト制限超過

### After (最適化後)
- 関連データのみ: 600-800文字
- 推定トークン数: 2,000-2,200トークン
- 効果: **95%削減**、コンテキスト制限内

## トラブルシューティング

### よくある問題

1. **人格データが読み込まれない**
   ```
   [MasterPromptManager] Persona data file not found: txt/kioku_hayate.txt
   ```
   → ファイルパスを確認、ファイルの存在を確認

2. **関連情報が見つからない**
   ```
   抽出結果: 文字数: 0 文字
   ```
   → キーワードマッチングロジックを確認、基本情報へのフォールバック

3. **コンテキスト制限に近い**
   ```
   推定トークン数: 3,500 トークン
   ```
   → `max_context_length`を700文字に調整

### デバッグ方法
```python
# 統計情報の確認
stats = manager.get_persona_statistics()
print(f"Status: {stats}")

# キーワード抽出のテスト
keywords = manager._extract_keywords_from_task("テスト質問")
print(f"Keywords: {keywords}")

# 人格情報抽出のテスト
info = manager._extract_relevant_persona_info("テスト質問")
print(f"Extracted: {len(info)} chars")
```

## 今後の改良点

### 実装予定
1. **セマンティック検索**: キーワードマッチングの精度向上
2. **動的制限調整**: プロンプト全体の長さに応じた制限の自動調整
3. **カテゴリ重み付け**: エントリーカテゴリごとの重要度設定
4. **学習機能**: よく使用される人格データの学習と優先度向上

### パフォーマンス最適化
1. **インデックス化**: 人格データの事前インデックス作成
2. **キャッシュ機能**: 頻繁に使用される組み合わせのキャッシュ
3. **並列処理**: 大量データ処理の並列化

## まとめ

この人格プロンプト統合システムにより、`txt/kioku_hayate.txt`の豊富な人格データを効率的に活用しながら、コンテキスト制限を遵守したプロンプト生成が可能になりました。

**主な成果:**
- ✅ 61,979文字の人格データを効率的に統合
- ✅ コンテキスト使用量を95%削減
- ✅ 関連性の高い情報を自動選択
- ✅ トークン制限内での安定した動作

システムは実用レベルで動作し、ハヤテの応答により深みのある人格的一貫性をもたらします。